# Ansible Role: k8s_get_join_command

`k8s_get_join_command` — This role generates the **`kubeadm join`** commands to add nodes to the Kubernetes cluster:
- one command for **workers**
- one command for **additional control-planes** (with `--control-plane` and `--certificate-key`).

## Requirements

- The cluster must already have been initialized with `kubeadm init` (see role `k8s_bootstrap_control_plane`).
- The role must be executed on the primary control-plane host (`k8s_primary_cp_host`).
- Kubernetes packages installed (`kubeadm`, `kubectl`).
- Python 3 and Ansible ≥ 2.15.

## Role Variables

Main variables (defined in `defaults/main.yml`):

| Variable | Default | Description |
|----------|---------|-------------|
| `k8s_primary_cp_host` | (required) | Inventory name of the primary control-plane host. |
| `k8s_kubeadm_bin` | `kubeadm` | Kubeadm binary. |
| `k8s_join_token_ttl` | `24h0m0s` | Validity duration of the `kubeadm` token. Empty = kubeadm default TTL. |
| `k8s_upload_certs` | `true` | Enables certificate upload for joining control-planes. |
| `k8s_extra_join_args` | `[]` | Additional arguments to add to the `join` command. |
| `k8s_admin_conf_path_check` | `/etc/kubernetes/admin.conf` | File whose presence confirms that the cluster is initialized. |
| `k8s_join_debug` | `false` | If true, prints the generated commands in debug. |

Outputs (facts defined on the primary, accessible via `hostvars`):

| Fact | Description |
|------|-------------|
| `k8s_join_command_worker` | Join command for a worker. |
| `k8s_join_command_control_plane` | Join command for an additional control-plane. |
| `k8s_certificate_key` | Certificate key generated by `upload-certs`. |

## Dependencies

No external dependencies.  
In practice, this role is often used after:
- `k8s_bootstrap_control_plane` (cluster init).
- before a role like `k8s_join_nodes` which actually executes the commands on other hosts.

## Example Playbook

Example to generate the commands on the primary:

```yaml
- name: Get join commands
  hosts: masters
  become: yes
  vars:
    k8s_primary_cp_host: kmaster1
    k8s_join_debug: true
  roles:
    - role: rridane.kubernetes.k8s_get_join_command
```

## Example

```yaml
- name: Join workers
  hosts: workers
  become: yes
  tasks:
    - name: Join this worker to cluster
      ansible.builtin.command: "{{ hostvars[k8s_primary_cp_host].k8s_join_command_worker }}"

- name: Join secondary masters
  hosts: masters:!kmaster1
  become: yes
  tasks:
    - name: Join this master to cluster
      ansible.builtin.command: "{{ hostvars[k8s_primary_cp_host].k8s_join_command_control_plane }}"
```

## License

BSD
