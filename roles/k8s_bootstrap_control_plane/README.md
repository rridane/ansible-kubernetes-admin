# Ansible Role: k8s_bootstrap_control_plane

This role bootstraps the **Kubernetes control-plane** via `kubeadm init`.  
It generates the `kubeadm.yaml` file, runs the initialization, and installs a usable `kubeconfig` for the administrator and/or a specified user.

## Requirements

- A Linux host with root access (or `become: yes`).
- Kubernetes packages already installed (`kubeadm`, `kubelet`, `kubectl`).
- A CNI (e.g. Calico, Cilium, Flannel) must be deployed **after** running the role for Pods to communicate.
- Optional: a `[masters]` group defined in the inventory.
- Python 3 and Ansible â‰¥ 2.15.

## Role Variables

Main variables (defined in `defaults/main.yml`):

| Variable | Default | Description |
|----------|---------|-------------|
| `k8s_primary_cp_host` | (must be defined in inventory) | Name of the primary control-plane host. |
| `k8s_kubeadm_config_path` | `/tmp/kubeadm.yaml` | Temporary path to render the kubeadm config file. |
| `k8s_kubeadm_bin` | `kubeadm` | Kubeadm binary to use. |
| `k8s_kubeadm_init_extra_args` | `[]` | Additional arguments to pass to `kubeadm init`. |
| `k8s_admin_conf_path_check` | `/etc/kubernetes/admin.conf` | File whose presence indicates that kubeadm is already initialized. |
| `k8s_kubeconfig_src` | `/etc/kubernetes/admin.conf` | Kubeconfig file generated by kubeadm. |
| `k8s_kubeconfig_dest` | `/root/.kube/config` | Destination of the kubeconfig for root. |
| `k8s_kubeconfig_owner` | `root` | Owner of the root kubeconfig. |
| `k8s_kubeconfig_group` | `root` | Group of the root kubeconfig. |
| `k8s_kubeconfig_dir_mode` | `0700` | Mode of the `~/.kube` directory. |
| `k8s_kubeconfig_file_mode` | `0600` | Mode of the kubeconfig file. |
| `k8s_copy_kubeconfig_for_user_enabled` | `false` | Enable copying a kubeconfig for a specific user. |
| `k8s_copy_kubeconfig_for_user` | dict | Details (owner, group, path) of the user kubeconfig. |
| `k8s_cluster_name` | `kubernetes` | Cluster name. |
| `k8s_kubernetes_version` | `v1.26.0` | Target Kubernetes version. |
| `k8s_control_plane_endpoint` | `""` | Control-plane DNS:port endpoint (required in HA). |
| `k8s_certificates_dir` | `/etc/kubernetes/pki` | Certificates directory. |
| `k8s_image_repository` | `registry.k8s.io` | Kubernetes image registry. |
| `k8s_advertise_address` | `{{ ansible_host }}` | kube-apiserver IP address. |
| `k8s_bind_port` | `6443` | kube-apiserver port. |
| `k8s_apiserver_certSANs` | `[]` | Additional SANs for the API server certificate. |
| `k8s_apiserver_extra_args` | `{ authorization-mode: "Node,RBAC" }` | Extra arguments for the API server. |
| `k8s_controller_manager_extra_args` | `{}` | Extra arguments for the controller-manager. |
| `k8s_scheduler_extra_args` | `{}` | Extra arguments for the scheduler. |
| `k8s_dns_domain` | `cluster.local` | Cluster internal domain. |
| `k8s_pod_subnet` | `10.244.0.0/16` | Pod CIDR. |
| `k8s_service_subnet` | `10.96.0.0/12` | Service CIDR. |
| `k8s_etcd_local_enabled` | `true` | Enable local etcd. |
| `k8s_etcd_data_dir` | `/mnt/data/etcd` | etcd data directory. |

## Dependencies

No external dependencies.  
You may chain with:
- A CNI role (Calico, Cilium, Flannel, etc.).
- A `k8s_cleanup_control_plane` role if you want to manage `state: absent`.

## Example Playbook

Example with a single-master cluster:

```yaml
- name: Bootstrap Kubernetes control-plane
  hosts: masters
  become: yes
  vars:
    k8s_primary_cp_host: kmaster1
    k8s_cluster_name: demo-cluster
    k8s_kubernetes_version: v1.30.4
    k8s_control_plane_endpoint: "api.demo.local:6443"
    k8s_apiserver_certSANs:
      - "127.0.0.1"
      - "localhost"
      - "api.demo.local"
  roles:
    - role: rridane.kubernetes.k8s_bootstrap_control_plane
```

## License

BSD

## Author Information

An optional section for the role authors to include contact information, or a website (HTML is not allowed).
